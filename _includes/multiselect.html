<!-- Petite Vue Script (only loaded on homepage) -->
<script src="https://unpkg.com/petite-vue" defer init></script>

<!-- Multiselect Manager Script -->
<script defer src="{{ '/assets/js/multiselect-manager.js' | relative_url }}"></script>

<!-- Multiselect Component for Indicators -->
<div class="flex items-center gap-2 sm:gap-3">
  <span
    class="hidden text-sm font-medium whitespace-nowrap text-gray-700 lg:inline dark:text-gray-300"
  >
    Indicador:
  </span>

  <div class="flex w-full items-center gap-2">
    <div class="relative min-w-0 flex-grow">
      <div
        v-scope="{ selectedIndicators: [], isOpen: false, indicators: [], indicatorMap: {}, yAxisConfig: {}, valuesDisplayConfig: {}, showConfig: false, activeFilter: 'Todo o per√≠odo' }"
        id="indicator-multiselect-container"
        class="h-full"
        @vue:mounted="
          window.multiselectScope = $data;
          // Ensure modal starts closed
          $data.showConfig = false;
          // Initialize valuesDisplayConfig as empty object if not present
          if (!$data.valuesDisplayConfig || typeof $data.valuesDisplayConfig !== 'object') {
            $data.valuesDisplayConfig = {};
          }
          // Add global click listener to close tooltips on mobile
          document.addEventListener('touchstart', (e) => {
            if (!e.target.closest('.tooltip-container')) {
              document.querySelectorAll('.tooltip-content').forEach(t => {
                t.classList.add('invisible', 'opacity-0');
                t.classList.remove('visible', 'opacity-100');
              });
            }
          });
        "
      >
        <!-- Custom multiselect button -->
        <button
          @click="isOpen = !isOpen"
          class="w-full rounded-md border border-gray-300 bg-white px-2 py-2 text-left text-sm text-gray-900 shadow-sm transition-all duration-200 hover:border-gray-400 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 focus:outline-none dark:border-gray-600 dark:bg-gray-800 dark:text-gray-100 dark:hover:border-gray-500"
        >
          <div class="flex w-full items-center justify-between">
            <span class="truncate pr-2">
              <span v-if="selectedIndicators.length === 0" class="text-gray-400">Selecione indicadores</span>
              <span
                v-else-if="selectedIndicators.length === 1"
                v-text="selectedIndicators[0]"
              ></span>
              <span v-else v-text="selectedIndicators.length + ' indicadores'"></span>
            </span>
            <span class="flex-shrink-0">‚ñº</span>
          </div>
        </button>

        <!-- Dropdown options -->
        <div
          v-show="isOpen"
          id="indicator-dropdown"
          class="absolute left-0 z-50 mt-1 max-h-60 w-full max-w-[calc(100vw-2rem)] min-w-64 overflow-y-auto rounded-md border border-gray-300 bg-white shadow-lg sm:min-w-80 dark:border-gray-600 dark:bg-gray-800"
        >
          <!-- Para mobile, ajustar posi√ß√£o se necess√°rio -->
          <div
            class="sm:hidden"
            v-if="isOpen"
            @vue:mounted="
              const dropdown = $el.parentElement;
              const rect = dropdown.getBoundingClientRect();

              // Ajusta posi√ß√£o vertical
              if (rect.bottom > window.innerHeight) {
                dropdown.style.top = 'auto';
                dropdown.style.bottom = '100%';
                dropdown.style.marginTop = '0';
                dropdown.style.marginBottom = '4px';
              }

              // Ajusta posi√ß√£o horizontal para n√£o sair da tela
              if (rect.right > window.innerWidth) {
                dropdown.style.left = 'auto';
                dropdown.style.right = '0';
              }
              if (rect.left < 0) {
                dropdown.style.left = '0';
                dropdown.style.right = 'auto';
              }
            "
          ></div>

          <!-- Grupos de Indicadores organizados por categoria -->

          <!-- Pol√≠tica Monet√°ria -->
          <div class="border-b border-gray-200 bg-gray-50 px-3 py-2 text-xs font-semibold tracking-wide text-gray-500 uppercase dark:border-gray-600 dark:bg-gray-700 dark:text-gray-400">
            üè¶ Pol√≠tica Monet√°ria
          </div>
          <div
            v-for="indicator in indicators.filter(i => i.group === 'monetary')"
            :key="indicator.id"
            @click="
              if (selectedIndicators.includes(indicator.name)) {
                selectedIndicators = selectedIndicators.filter(v => v !== indicator.name);
                delete yAxisConfig[indicator.name];
              } else {
                selectedIndicators = [...selectedIndicators, indicator.name];
                yAxisConfig[indicator.name] = 'left';
              }
              if (typeof gtag !== 'undefined') {
                gtag('event', 'indicator_selected', {
                  indicator_name: indicator.name,
                  indicator_file: indicator.datafile,
                  selection_type: 'multiselect'
                });
              }
              window.updateChartsFromMultiselect && window.updateChartsFromMultiselect(selectedIndicators, indicatorMap, false, yAxisConfig, valuesDisplayConfig);
            "
            class="flex cursor-pointer items-center justify-between px-3 py-2 pl-6 hover:bg-gray-100 dark:text-white dark:hover:bg-gray-700"
          >
            <div class="flex-grow">
              <span v-text="indicator.name" class="block"></span>
              <span
                v-if="indicator.granularity"
                v-text="indicator.granularity"
                class="block text-xs text-gray-500 dark:text-gray-400"
              ></span>
            </div>
            <div class="flex items-center">
              {% include tooltip-info.html %}
              <span
                :class="{'opacity-0': !selectedIndicators.includes(indicator.name)}"
                class="w-5 text-center font-bold text-blue-500"
                >‚úì</span
              >
            </div>
          </div>

          <!-- Infla√ß√£o -->
          <div class="border-b border-gray-200 bg-gray-50 px-3 py-2 text-xs font-semibold tracking-wide text-gray-500 uppercase dark:border-gray-600 dark:bg-gray-700 dark:text-gray-400">
            üìà Infla√ß√£o
          </div>
          <div
            v-for="indicator in indicators.filter(i => i.group === 'inflation')"
            :key="indicator.id"
            @click="
              if (selectedIndicators.includes(indicator.name)) {
                selectedIndicators = selectedIndicators.filter(v => v !== indicator.name);
                delete yAxisConfig[indicator.name];
              } else {
                selectedIndicators = [...selectedIndicators, indicator.name];
                yAxisConfig[indicator.name] = 'left';
              }
              if (typeof gtag !== 'undefined') {
                gtag('event', 'indicator_selected', {
                  indicator_name: indicator.name,
                  indicator_file: indicator.datafile,
                  selection_type: 'multiselect'
                });
              }
              window.updateChartsFromMultiselect && window.updateChartsFromMultiselect(selectedIndicators, indicatorMap, false, yAxisConfig, valuesDisplayConfig);
            "
            class="flex cursor-pointer items-center justify-between px-3 py-2 pl-6 hover:bg-gray-100 dark:text-white dark:hover:bg-gray-700"
          >
            <div class="flex-grow">
              <span v-text="indicator.name" class="block"></span>
              <span
                v-if="indicator.granularity"
                v-text="indicator.granularity"
                class="block text-xs text-gray-500 dark:text-gray-400"
              ></span>
            </div>
            <div class="flex items-center">
              {% include tooltip-info.html %}
              <span
                :class="{'opacity-0': !selectedIndicators.includes(indicator.name)}"
                class="w-5 text-center font-bold text-blue-500"
                >‚úì</span
              >
            </div>
          </div>

          <!-- Crescimento Econ√¥mico -->
          <div class="border-b border-gray-200 bg-gray-50 px-3 py-2 text-xs font-semibold tracking-wide text-gray-500 uppercase dark:border-gray-600 dark:bg-gray-700 dark:text-gray-400">
            üìä Crescimento Econ√¥mico
          </div>
          <div
            v-for="indicator in indicators.filter(i => i.group === 'growth')"
            :key="indicator.id"
            @click="
              if (selectedIndicators.includes(indicator.name)) {
                selectedIndicators = selectedIndicators.filter(v => v !== indicator.name);
                delete yAxisConfig[indicator.name];
              } else {
                selectedIndicators = [...selectedIndicators, indicator.name];
                yAxisConfig[indicator.name] = 'left';
              }
              if (typeof gtag !== 'undefined') {
                gtag('event', 'indicator_selected', {
                  indicator_name: indicator.name,
                  indicator_file: indicator.datafile,
                  selection_type: 'multiselect'
                });
              }
              window.updateChartsFromMultiselect && window.updateChartsFromMultiselect(selectedIndicators, indicatorMap, false, yAxisConfig, valuesDisplayConfig);
            "
            class="flex cursor-pointer items-center justify-between px-3 py-2 pl-6 hover:bg-gray-100 dark:text-white dark:hover:bg-gray-700"
          >
            <div class="flex-grow">
              <span v-text="indicator.name" class="block"></span>
              <span
                v-if="indicator.granularity"
                v-text="indicator.granularity"
                class="block text-xs text-gray-500 dark:text-gray-400"
              ></span>
            </div>
            <div class="flex items-center">
              {% include tooltip-info.html %}
              <span
                :class="{'opacity-0': !selectedIndicators.includes(indicator.name)}"
                class="w-5 text-center font-bold text-blue-500"
                >‚úì</span
              >
            </div>
          </div>

          <!-- Clear all button -->
          <div
            v-if="selectedIndicators.length > 0"
            class="border-t border-gray-200 bg-gray-50 p-3 dark:border-gray-600 dark:bg-gray-700"
          >
            <button
              @click="
                selectedIndicators = [];
                yAxisConfig = {};
                valuesDisplayConfig = {};
                window.updateChartsFromMultiselect && window.updateChartsFromMultiselect(selectedIndicators, indicatorMap, true);
              "
              class="w-full rounded border border-red-200 px-3 py-2 text-xs font-medium text-red-600 transition-colors hover:border-red-300 hover:bg-red-50 hover:text-red-800 dark:border-red-800 dark:text-red-400 dark:hover:border-red-700 dark:hover:bg-red-900/20"
            >
              üóëÔ∏è Limpar todos
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Configuration Button -->
    <button
      onclick="
        const modal = document.getElementById('config-modal');
        if (modal && window.multiselectScope) {
          // Dispara evento customizado para sincronizar dados
          const syncEvent = new CustomEvent('sync-modal-data', {
            detail: {
              selectedIndicators: [...window.multiselectScope.selectedIndicators],
              indicatorMap: {...window.multiselectScope.indicatorMap},
              yAxisConfig: {...window.multiselectScope.yAxisConfig},
              valuesDisplayConfig: {...window.multiselectScope.valuesDisplayConfig},
              activeFilter: window.multiselectScope.activeFilter
            }
          });
          modal.dispatchEvent(syncEvent);
          modal.classList.add('show');
          if (typeof onConfigModalOpen === 'function') {
            onConfigModalOpen();
          }
        }
      "
      class="flex h-10 w-10 flex-shrink-0 items-center justify-center rounded-md border border-gray-300 bg-white text-gray-600 transition-colors hover:bg-gray-50 hover:text-gray-800 focus:ring-2 focus:ring-blue-500 focus:ring-offset-1 focus:outline-none dark:border-gray-600 dark:bg-gray-800 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-gray-200"
      title="Configura√ß√µes de filtros e eixos"
    >
      <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
      </svg>
    </button>
  </div>
</div>

{% include config-modal.html %}
