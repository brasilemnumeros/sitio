<!-- Petite Vue Script (only loaded on homepage) -->
<script src="https://unpkg.com/petite-vue" defer init></script>

<!-- Multiselect Manager Script -->
<script defer src="{{ '/assets/js/multiselect-manager.js' | relative_url }}"></script>

<!-- Multiselect Component for Indicators -->
<div class="flex items-center gap-2 sm:gap-3">
  <label
    class="hidden text-sm font-medium whitespace-nowrap text-gray-700 lg:inline dark:text-gray-300"
  >
    Indicador:
  </label>

  <div class="relative">
    <div
      v-scope="{ selectedIndicators: [], isOpen: false, indicators: [], indicatorMap: {}, yAxisConfig: {} }"
      id="indicator-multiselect-container"
      @vue:mounted="
        window.multiselectScope = $data;
        // Add global click listener to close tooltips on mobile
        document.addEventListener('touchstart', (e) => {
          if (!e.target.closest('.tooltip-container')) {
            document.querySelectorAll('.tooltip-content').forEach(t => {
              t.classList.add('invisible', 'opacity-0');
              t.classList.remove('visible', 'opacity-100');
            });
          }
        });
      "
    >
      <!-- Custom multiselect button -->
      <button
        @click="isOpen = !isOpen"
        class="w-[calc(100vw-140px)] rounded-md border border-gray-300 bg-white px-2 py-2 text-left text-sm text-gray-900 shadow-sm transition-all duration-200 hover:border-gray-400 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 focus:outline-none sm:w-60 sm:max-w-[calc(100vw-350px)] md:w-80 md:min-w-80 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-100 dark:hover:border-gray-500"
      >
        <div class="flex w-full items-center justify-between">
          <span class="truncate pr-2">
            <span v-if="selectedIndicators.length === 0" class="text-gray-400">Selecione indicadores</span>
            <span
              v-else-if="selectedIndicators.length === 1"
              v-text="selectedIndicators[0].replace(/^[üè¶üìà]\s/, '')"
            ></span>
            <span v-else v-text="selectedIndicators.length + ' indicadores'"></span>
          </span>
          <span class="flex-shrink-0">‚ñº</span>
        </div>
      </button>

      <!-- Dropdown options -->
      <div
        v-show="isOpen"
        id="indicator-dropdown"
        class="absolute left-0 z-50 mt-1 max-h-60 w-[calc(100vw-140px)] overflow-y-auto rounded-md border border-gray-300 bg-white shadow-lg sm:left-auto sm:w-60 sm:max-w-[calc(100vw-350px)] md:w-80 dark:border-gray-600 dark:bg-gray-800"
      >
        <!-- Para mobile, ajustar posi√ß√£o se necess√°rio -->
        <div
          class="sm:hidden"
          v-if="isOpen"
          @vue:mounted="
            const dropdown = $el.parentElement;
            const rect = dropdown.getBoundingClientRect();
            if (rect.bottom > window.innerHeight) {
              dropdown.style.top = 'auto';
              dropdown.style.bottom = '100%';
              dropdown.style.marginTop = '0';
              dropdown.style.marginBottom = '4px';
            }
          "
        ></div>

        <!-- Indicadores Econ√¥micos -->
        <div class="border-b border-gray-200 bg-gray-50 px-3 py-2 text-xs font-semibold tracking-wide text-gray-500 uppercase dark:border-gray-600 dark:bg-gray-700 dark:text-gray-400">
          Indicadores Econ√¥micos
        </div>

        <!-- Dynamic indicator options -->
        <div
          v-for="indicator in indicators"
          :key="indicator.id"
          @click="
            if (selectedIndicators.includes(indicator.name)) {
              selectedIndicators = selectedIndicators.filter(v => v !== indicator.name);
              // Remove from yAxisConfig when unselected
              delete yAxisConfig[indicator.name];
            } else {
              selectedIndicators = [...selectedIndicators, indicator.name];
              // Set default to left axis for new selections
              yAxisConfig[indicator.name] = 'left';
            }
            // GTM tracking
            if (typeof gtag !== 'undefined') {
              gtag('event', 'indicator_selected', {
                indicator_name: indicator.name,
                indicator_file: indicator.datafile,
                selection_type: 'multiselect'
              });
            }
            window.updateChartsFromMultiselect && window.updateChartsFromMultiselect(selectedIndicators, indicatorMap, false, yAxisConfig);
          "
          class="flex cursor-pointer items-center justify-between px-3 py-2 pl-6 hover:bg-gray-100 dark:text-white dark:hover:bg-gray-700"
        >
          <div class="flex-grow">
            <span v-text="indicator.name" class="block"></span>
            <span
              v-if="indicator.granularity"
              v-text="indicator.granularity"
              class="block text-xs text-gray-500 dark:text-gray-400"
            ></span>
          </div>
          <div class="flex items-center">
            {% include tooltip-info.html %}
            <span
              :class="{'opacity-0': !selectedIndicators.includes(indicator.name)}"
              class="w-5 text-center font-bold text-blue-500"
              >‚úì</span
            >
          </div>
        </div>

        <!-- Clear all button -->
        <div
          v-if="selectedIndicators.length > 0"
          class="border-t border-gray-200 bg-gray-50 p-3 dark:border-gray-600 dark:bg-gray-700"
        >
          <button
            @click="
              selectedIndicators = [];
              yAxisConfig = {};
              window.updateChartsFromMultiselect && window.updateChartsFromMultiselect(selectedIndicators, indicatorMap, true);
            "
            class="w-full rounded border border-red-200 px-3 py-2 text-xs font-medium text-red-600 transition-colors hover:border-red-300 hover:bg-red-50 hover:text-red-800 dark:border-red-800 dark:text-red-400 dark:hover:border-red-700 dark:hover:bg-red-900/20"
          >
            üóëÔ∏è Limpar todos
          </button>
        </div>

        <!-- Y-Axis Configuration Panel -->
        <div
          v-if="selectedIndicators.length > 1"
          class="border-t border-gray-200 bg-gray-50 p-3 dark:border-gray-600 dark:bg-gray-700"
        >
          <div class="mb-2 text-xs font-semibold text-gray-600 dark:text-gray-400">‚öôÔ∏è Configura√ß√£o dos Eixos Y</div>
          <div class="space-y-2">
            <div
              v-for="indicator in selectedIndicators"
              :key="indicator"
              class="flex items-center justify-between"
            >
              <span
                class="truncate pr-2 text-xs text-gray-700 dark:text-gray-300"
                v-text="indicator.replace(/^[üè¶üìàüìä]\s/, '')"
              ></span>
              <div class="flex rounded border border-gray-300 dark:border-gray-600">
                <button
                  @click="
                    yAxisConfig[indicator] = 'left';
                    window.updateChartsFromMultiselect && window.updateChartsFromMultiselect(selectedIndicators, indicatorMap, false, yAxisConfig);
                  "
                  :class="
                    {
                      'bg-blue-500 text-white': (yAxisConfig[indicator] || 'left') === 'left',
                      'bg-white text-gray-700 hover:bg-gray-50': (yAxisConfig[indicator] || 'left') !== 'left'
                    }
                  "
                  class="border-r border-gray-300 px-2 py-1 text-xs font-medium transition-colors dark:border-gray-600"
                  title="Eixo Y Esquerdo"
                >
                  ‚¨ÖÔ∏è
                </button>
                <button
                  @click="
                    yAxisConfig[indicator] = 'right';
                    window.updateChartsFromMultiselect && window.updateChartsFromMultiselect(selectedIndicators, indicatorMap, false, yAxisConfig);
                  "
                  :class="
                    {
                      'bg-blue-500 text-white': (yAxisConfig[indicator] || 'left') === 'right',
                      'bg-white text-gray-700 hover:bg-gray-50': (yAxisConfig[indicator] || 'left') !== 'right'
                    }
                  "
                  class="px-2 py-1 text-xs font-medium transition-colors"
                  title="Eixo Y Direito"
                >
                  ‚û°Ô∏è
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
